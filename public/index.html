<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pisscord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #12121d);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      background: #2b2b3c;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
    }
    .avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      box-shadow: 0 0 0 3px #5865f2;
      margin-bottom: 1rem;
      transition: box-shadow 0.3s ease;
    }
    .username {
      font-size: 1.6rem;
      font-weight: bold;
    }
    .id {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 1.5rem;
      user-select: all;
    }
    .bot-tag {
      background: #7289da;
      color: white;
      font-weight: bold;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
      margin-left: 0.5rem;
      vertical-align: middle;
    }
    .created {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      color: #ccc;
    }
    .banner {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 0 10px #5865f2;
    }
    .badges {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.4rem;
      margin-top: 1rem;
    }
    .badge {
      height: 48px;
      border-radius: 6px;
      transition: transform 0.2s ease;
      cursor: default;
    }
    .badge:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 6px #777);
    }
    #error {
      color: #ff4d4d;
      background: #1a0000;
      padding: 1rem;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="card" id="content">Loading...</div>

  <script>
    const id = new URLSearchParams(location.search).get("id");
    const content = document.getElementById("content");

    const badgeIcons = {
      DISCORD_EMPLOYEE: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/staff.png",
      PARTNERED_SERVER_OWNER: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/partnered_server_owner.png",
      HYPESQUAD_EVENTS: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/hypesquad_events.png",
      BUG_HUNTER_LEVEL_1: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/bug_hunter_level_1.png",
      HOUSE_BRAVERY: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/hypesquad_bravery.png",
      HOUSE_BRILLIANCE: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/hypesquad_brilliance.png",
      HOUSE_BALANCE: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/hypesquad_balance.png",
      EARLY_SUPPORTER: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/early_supporter.png",
      BUG_HUNTER_LEVEL_2: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/bug_hunter_level_2.png",
      VERIFIED_DEVELOPER: "https://raw.githubusercontent.com/merlinfuchs/discord-badges/refs/heads/main/PNG/early_verified_developer.png"
    };

    const flagsMap = {
      1: "DISCORD_EMPLOYEE",
      2: "PARTNERED_SERVER_OWNER",
      4: "HYPESQUAD_EVENTS",
      8: "BUG_HUNTER_LEVEL_1",
      64: "HOUSE_BRAVERY",
      128: "HOUSE_BRILLIANCE",
      256: "HOUSE_BALANCE",
      512: "EARLY_SUPPORTER",
      4096: "SYSTEM",
      16384: "BUG_HUNTER_LEVEL_2",
      131072: "VERIFIED_DEVELOPER"
    };

    // Discord snowflake timestamp helper
    function getCreationDateFromSnowflake(snowflake) {
      const DISCORD_EPOCH = 1420070400000;
      return new Date((BigInt(snowflake) >> 22n) + BigInt(DISCORD_EPOCH));
    }

    async function load() {
      if (!id) {
        content.innerHTML = `<div id="error">Missing <code>?id=</code> in URL.</div>`;
        return;
      }

      try {
        const [userRes, badgeRes] = await Promise.all([
          fetch(`/api?id=${id}`),
          fetch("https://obs-akuma.github.io/PisscordLookup/Badges.json")
        ]);

        const user = await userRes.json();
        const badgeData = await badgeRes.json();

        if (user.error) {
          content.innerHTML = `<div id="error">User not found.</div>`;
          return;
        }

        // Build system badges from flags
        const publicFlags = user.public_flags ?? 0;
        const systemBadges = Object.entries(flagsMap)
          .filter(([bit, _]) => (publicFlags & bit) !== 0)
          .map(([_, name]) => badgeIcons[name])
          .filter(Boolean);

        // Custom badges with tooltip from badgeData
        const customBadges = (badgeData[id] || []).map(b => {
          return { url: b.badge, tooltip: b.tooltip || "" };
        });

        // User avatar URL, fallback avatar
        const avatarUrl = user.avatar
          ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
          : `https://cdn.discordapp.com/embed/avatars/0.png`;

        // User banner URL if present
        const bannerUrl = user.banner
          ? `https://cdn.discordapp.com/banners/${user.id}/${user.banner}.png?size=512`
          : null;

        // Calculate account creation date
        const createdDate = getCreationDateFromSnowflake(user.id);
        const createdStr = createdDate.toLocaleDateString(undefined, {
          year: "numeric", month: "long", day: "numeric"
        });

        // Accent color as border around avatar if exists
        const accentColor = user.accent_color
          ? `#${user.accent_color.toString(16).padStart(6, "0")}`
          : null;

        // Compose badges HTML
        let badgeImgs = "";
        if (systemBadges.length > 0 || customBadges.length > 0) {
          badgeImgs = `<div class="badges">` +
            [
              ...systemBadges.map(url => `<img class="badge" src="${url}">`),
              ...customBadges.map(b => `<img class="badge" src="${b.url}" title="${b.tooltip}">`)
            ].join("") +
            `</div>`;
        }

        content.innerHTML = `
          ${bannerUrl ? `<img class="banner" src="${bannerUrl}" alt="User Banner">` : ""}
          <img
            class="avatar"
            src="${avatarUrl}"
            alt="avatar"
            style="box-shadow: 0 0 0 3px ${accentColor ?? "#5865f2"};"
          >
          <div class="username">
            ${user.username}${user.discriminator !== "0" ? `#${user.discriminator}` : ""}
            ${user.bot ? '<span class="bot-tag">BOT</span>' : ''}
          </div>
          <div class="id" title="User ID (click to copy)">${user.id}</div>
          <div class="created">Account Created: ${createdStr}</div>
          ${badgeImgs}
        `;

        // Optional: Click user ID to copy
        const idElem = content.querySelector(".id");
        if (idElem) {
          idElem.style.cursor = "pointer";
          idElem.onclick = () => {
            navigator.clipboard.writeText(user.id);
            idElem.textContent = "Copied!";
            setTimeout(() => {
              idElem.textContent = user.id;
            }, 1500);
          };
        }
      } catch (err) {
        content.innerHTML = `<div id="error">Failed to load user.</div>`;
        console.error(err);
      }
    }

    load();
  </script>
</body>
</html>
